---
title: "Using the CVEK R package"
author: "Wenying Deng"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the CVEK R package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Short Description

Using a library of base kernels, **CVEK** learns a proper 
generating function from data by directly minimizing the ensemble 
model’s error, and tests whether the data is generated by the RKHS 
under the null hypothesis.

Download the package from CRAN or [GitHub](https://github.com/IrisTeng/CVEK-1) and then install and load it.

```{r, message = FALSE}
devtools::install_github("IrisTeng/CVEK-1")
library(CVEK)
```


## Test Functions
### Estimation

We can apply *estimation* function to conduct Gaussian process regression.

*estimation* function has seven returns with seven parameters.
```{r}
estimation
```

Note that:

* The first two parameters *Y* and *X* are mandatory for management.
* *estimation* is the core function for estimation, which is nested in the main function *cvek*.
* If the third parameter *K_list* is not given, the model will conduct linear regression.
* For the last four parameters, users can substitute alternatives for the default ones.


For example, we have a training dataset with $n=100$, and no alternative effect,

```{r}
set.seed(0726)
n <- 150 # including training and test
d <- 6
data <- as.data.frame(matrix(
  rnorm(n * d),
  ncol = d,
  dimnames = list(NULL, paste0("x", 1:d))
))
beta_true <- c(1, .41, 2.37)
data$y <- as.matrix(cbind(1, data[, c("x1", "x2")])) %*% beta_true

data_train <- data[1:100, ]
data_test <- data[101:150, ]
```


```{r, echo=FALSE, results='asis'}
knitr::kable(head(data_train, 10))
```

We want our kernel library to contain three kernels: $"linear"$, $"polynomial"$ with $p=2$, and $"rbf"$ with $l=1.5, p=3$:

```{r}
kern_par <- data.frame(method = c("linear", "polynomial", "rbf"), 
                         l = c(.5, 1, 1.5), p = 1:3, stringsAsFactors = FALSE)
  # define kernel library
kern_func_list <- define_library(kern_par)
```

And the null model is $y \sim x1 + x2 + k(x3, x4) + k(x5, x6)$:
```{r}
formula <- y ~ x1 + x2 + k(x3, x4) + k(x5, x6)
```

With all these parameters specified, we can conducts Gaussian process regression,

```{r}
est_res <- cvek(formula, kern_func_list = kern_func_list, data = data_train)
# est_res$lambda
# est_res$beta
# est_res$u_hat
```


### Testing

Then, here comes the testing procedure.

*cvek_test* function has one return with several parameters.
```{r}
cvek_test
```

Note that we can use the same function *cvek* as estimation to perform hypothesis testing, but we need to provide $formula\_test$, which is the user-supplied formula indicating the alternative 
effect to test.

Now, we want to conduct score test with $test="boot"$ and $B=200$ since the sample n is small ($n=100$).

```{r}
formula_test <- y ~ k(x1):k(x4, x5)
pvalue <- cvek(formula, kern_func_list = kern_func_list, 
               data = data_train, formula_test = formula_test,
               mode = "loocv", strategy = "stack",
               beta_exp = 1, lambda = exp(seq(-10, 5)),
               test = "boot", alt_kernel_type = "ensemble",
               B = 200, verbose = FALSE)$pvalue
```

### Prediction

Finally, we can prediction new outcomes based on estimation result.

*predict.cvek* function has one return with two parameters.
```{r}
predict.cvek
```

Now that we have the estimation result *est_res*, we can predict new outcomes.
```{r}
y_pred <- predict(est_res, data_test[, 1:6])
data_test_pred <- cbind(data_test, y_pred)
```


```{r, echo=FALSE, results='asis'}
knitr::kable(head(data_test_pred, 10))
```


## References

1.  Jeremiah Zhe Liu and Brent Coull. Robust Hypothesis Test for Nonlinear Effect       with Gaussian Processes. October 2017.
1.  Xiang Zhan, Anna Plantinga, Ni Zhao, and Michael C. Wu. A fast small-sample         kernel inde- pendence test for microbiome community-level association analysis.     December 2017.
1.  Arnak S. Dalalyan and Alexandre B. Tsybakov. Aggregation by Exponential             Weighting and Sharp Oracle Inequalities. In Learning Theory, Lecture Notes in       Computer Science, pages 97– 111. Springer, Berlin, Heidelberg, June 2007.
1.  Arnab Maity and Xihong Lin. Powerful tests for detecting a gene effect in the       presence of possible gene-gene interactions using garrote kernel machines.          December 2011.
1.  The MIT Press. Gaussian Processes for Machine Learning, 2006.
1.  Xihong Lin. Variance component testing in generalised linear models with random     effects. June 1997.
1.  Philip S. Boonstra, Bhramar Mukherjee, and Jeremy M. G. Taylor. A Small-Sample      Choice of the Tuning Parameter in Ridge Regression. July 2015.
1.  Trevor Hastie, Robert Tibshirani, and Jerome Friedman. The Elements of              Statistical Learning: Data Mining, Inference, and Prediction, Second Edition.       Springer Series in Statistics. Springer- Verlag, New York, 2 edition, 2009.
1.  Hirotogu Akaike. Information Theory and an Extension of the Maximum Likelihood      Princi- ple. In Selected Papers of Hirotugu Akaike, Springer Series in              Statistics, pages 199–213. Springer, New York, NY, 1998.
1.  Clifford M. Hurvich and Chih-Ling Tsai. Regression and time series model            selection in small samples. June 1989.
1.  Hurvich Clifford M., Simonoff Jeffrey S., and Tsai Chih-Ling. Smoothing             parameter selection in nonparametric regression using an improved Akaike            information criterion. January 2002.
